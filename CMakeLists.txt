# Copyright (c) 2014 The Chromium Embedded Framework Authors. All rights
# reserved. Use of this source code is governed by a BSD-style license that
# can be found in the LICENSE file.


#
# í¸ì˜
#

list(APPEND CEF_CXX_COMPILER_FLAGS /wd4267 /wd4199 /IGNORE:4199)


#
# ê³µí†µ ì„¤ì •
#

# ëˆˆì— ë„ëŠ” ë§¤í¬ë¡œ ì •ì˜ ì¶”ê°€
macro(message_ TITLE MESSAGE)
  message(STATUS "âœ¨ğŸš€âœ¨===== ${TITLE} =====âœ¨ğŸš€âœ¨")
  message(STATUS "ğŸ”” ${MESSAGE} ğŸ””")
endmacro()

# ë¹Œë“œ ê³¼ì •ì—ì„œ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì¶œë ¥
# set(CMAKE_VERBOSE_MAKEFILE ON)

# CMake ìµœì†Œ ë²„ì „ ì„¤ì •
cmake_minimum_required(VERSION 3.20 FATAL_ERROR)

# íƒ€ê²Ÿ ì‹¤í–‰ íŒŒì¼ ì´ë¦„ ì„¤ì •
set(COGNISTREAM_TARGET "cognistream")

# í”„ë¡œì íŠ¸ ì´ë¦„ ì„¤ì •
project(${COGNISTREAM_TARGET})

# include ë””ë ‰í† ë¦¬ ì„¤ì •
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°
find_package(CEF REQUIRED)
find_package(Torch REQUIRED)

# CMake ëª¨ë“ˆ ê²½ë¡œ ì„¤ì •
if(OS_MAC)
  set(CEF_HELPER_TARGET "cognistream_Helper")
  set(CEF_HELPER_OUTPUT_NAME "cognistream Helper")
else()
  # libcef ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬ë¥¼ ìœ„í•œ ë…¼ë¦¬ íƒ€ê²Ÿ
  ADD_LOGICAL_TARGET("libcef_lib" "${CEF_LIB_DEBUG}" "${CEF_LIB_RELEASE}")
endif()

# íƒ€ê²Ÿ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì„¤ì •
SET_CEF_TARGET_OUT_DIR()


#
# libtorch ì„¤ì •
#

# libtorch dll íŒŒì¼ ë³µì‚¬
macro(ADD_WINDOWS_TORCH_DLLS target install_prefix)
file(GLOB TORCH_DLLS ${install_prefix}/lib/*.dll)
add_custom_command(
  TARGET ${target}
  POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E copy_if_different
  ${TORCH_DLLS}
  $<TARGET_FILE_DIR:${target}>)
endmacro()

# CEF ë³€ìˆ˜ì— libtorch ë³€ìˆ˜ ì¶”ê°€
list(REMOVE_ITEM CEF_COMPILER_FLAGS /GR- /WX)
list(REMOVE_ITEM CEF_CXX_COMPILER_FLAGS /GR- /WX)
list(APPEND CEF_CXX_COMPILER_FLAGS ${TORCH_CXX_FLAGS})
list(APPEND CEF_STANDARD_LIBS ${TORCH_LIBRARIES})


#
# ì†ŒìŠ¤ íŒŒì¼ ì„¤ì •
#

# cognistream ì†ŒìŠ¤ íŒŒì¼
set(COGNISTREAM_SRCS
  simple_app.cc
  simple_app.h
  simple_handler.cc
  simple_handler.h
)
set(COGNISTREAM_SRCS_LINUX
  main_linux.cc
  simple_handler_linux.cc
)
set(COGNISTREAM_SRCS_MAC
  main_mac.mm
  simple_handler_mac.mm
)
set(COGNISTREAM_SRCS_WINDOWS
  main_win.cc
  resource.h
  simple_handler_win.cc
)
APPEND_PLATFORM_SOURCES(COGNISTREAM_SRCS)
source_group(cognistream FILES ${COGNISTREAM_SRCS})

set(COGNISTREAM_WIN_SRCS_WINDOWS
  win/cognistream.rc
)
APPEND_PLATFORM_SOURCES(COGNISTREAM_WIN_SRCS)
source_group(cognistream\\win FILES ${COGNISTREAM_WIN_SRCS})

set(COGNISTREAM_SRCS
  ${COGNISTREAM_SRCS}
  ${COGNISTREAM_WIN_SRCS}
)

# cognistream í—¬í¼ ì†ŒìŠ¤ íŒŒì¼
set(COGNISTREAM_HELPER_SRCS_MAC
  process_helper_mac.cc
)
APPEND_PLATFORM_SOURCES(COGNISTREAM_HELPER_SRCS)
source_group(cognistream FILES ${COGNISTREAM_HELPER_SRCS})

# cognistream ë¦¬ì†ŒìŠ¤ íŒŒì¼
set(COGNISTREAM_RESOURCES_MAC_SRCS_MAC
  mac/Info.plist.in
  mac/cognistream.icns
)
APPEND_PLATFORM_SOURCES(COGNISTREAM_RESOURCES_MAC_SRCS)
source_group(cognistream\\mac FILES ${COGNISTREAM_RESOURCES_MAC_SRCS})

set(COGNISTREAM_RESOURCES_MAC_ENGLISH_LPROJ_SRCS_MAC
  mac/English.lproj/InfoPlist.strings
  mac/English.lproj/MainMenu.xib
)
APPEND_PLATFORM_SOURCES(COGNISTREAM_RESOURCES_MAC_ENGLISH_LPROJ_SRCS)
source_group(cognistream\\mac\\English.lproj FILES ${COGNISTREAM_RESOURCES_MAC_ENGLISH_LPROJ_SRCS})

set(COGNISTREAM_RESOURCES_SRCS
  ${COGNISTREAM_RESOURCES_MAC_SRCS}
  ${COGNISTREAM_RESOURCES_MAC_ENGLISH_LPROJ_SRCS}
)


#
# ë¦¬ëˆ…ìŠ¤ êµ¬ì„±
#

if(OS_LINUX)
  # ì‹¤í–‰ íŒŒì¼ íƒ€ê²Ÿ ìƒì„±
  add_executable(${COGNISTREAM_TARGET} ${COGNISTREAM_SRCS})
  SET_EXECUTABLE_TARGET_PROPERTIES(${COGNISTREAM_TARGET})
  add_subdirectory(${CEF_LIBCEF_DLL_WRAPPER_PATH} libcef_dll_wrapper)
  target_link_libraries(${COGNISTREAM_TARGET} libcef_lib libcef_dll_wrapper ${CEF_STANDARD_LIBS})

  # rpath ì„¤ì •í•˜ì—¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‹¤í–‰ íŒŒì¼ ì˜†ì— ë°°ì¹˜ ê°€ëŠ¥
  set_target_properties(${COGNISTREAM_TARGET} PROPERTIES INSTALL_RPATH "$ORIGIN")
  set_target_properties(${COGNISTREAM_TARGET} PROPERTIES BUILD_WITH_INSTALL_RPATH TRUE)
  set_target_properties(${COGNISTREAM_TARGET} PROPERTIES RUNTIME_OUTPUT_DIRECTORY ${CEF_TARGET_OUT_DIR})

  # ë°”ì´ë„ˆë¦¬ ë° ë¦¬ì†ŒìŠ¤ íŒŒì¼ì„ íƒ€ê²Ÿ ì¶œë ¥ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
  COPY_FILES("${COGNISTREAM_TARGET}" "${CEF_BINARY_FILES}" "${CEF_BINARY_DIR}" "${CEF_TARGET_OUT_DIR}")
  COPY_FILES("${COGNISTREAM_TARGET}" "${CEF_RESOURCE_FILES}" "${CEF_RESOURCE_DIR}" "${CEF_TARGET_OUT_DIR}")
  if(EXISTS "${CEF_BINARY_DIR}/libminigbm.so")
    COPY_FILES("${COGNISTREAM_TARGET}" "libminigbm.so" "${CEF_BINARY_DIR}" "${CEF_TARGET_OUT_DIR}")
  endif()

  # chrome-sandbox íƒ€ê²Ÿì— SUID ê¶Œí•œ ì„¤ì •
  SET_LINUX_SUID_PERMISSIONS("${COGNISTREAM_TARGET}" "${CEF_TARGET_OUT_DIR}/chrome-sandbox")
endif()


#
# Mac OS X êµ¬ì„±
#

if(OS_MAC)
  option(OPTION_USE_ARC "macOSì—ì„œ ARC(ìë™ ì°¸ì¡° ì¹´ìš´íŒ…) ì‚¬ìš© ì—¬ë¶€." ON)
  if(OPTION_USE_ARC)
    list(APPEND CEF_COMPILER_FLAGS
      -fobjc-arc
    )
    set_target_properties(${target} PROPERTIES
      CLANG_ENABLE_OBJC_ARC "YES"
    )
  endif()

  # ë©”ì¸ ì•± ë²ˆë“¤ ì¶œë ¥ ê²½ë¡œ
  set(CEF_APP "${CEF_TARGET_OUT_DIR}/${COGNISTREAM_TARGET}.app")

  # ì£¼ìš” Info.plist íŒŒì¼ì—ì„œ ì°¸ì¡°ë˜ëŠ” ë³€ìˆ˜
  set(EXECUTABLE_NAME "${COGNISTREAM_TARGET}")
  set(PRODUCT_NAME "${COGNISTREAM_TARGET}")

  if(USE_SANDBOX)
    # cef_sandbox ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§í¬í•˜ê¸° ìœ„í•œ ë…¼ë¦¬ íƒ€ê²Ÿ
    ADD_LOGICAL_TARGET("cef_sandbox_lib" "${CEF_SANDBOX_LIB_DEBUG}" "${CEF_SANDBOX_LIB_RELEASE}")
  endif()

  # ë©”ì¸ ì•± ë²ˆë“¤ íƒ€ê²Ÿ ìƒì„±
  add_executable(${COGNISTREAM_TARGET} MACOSX_BUNDLE ${COGNISTREAM_RESOURCES_SRCS} ${COGNISTREAM_SRCS})
  SET_EXECUTABLE_TARGET_PROPERTIES(${COGNISTREAM_TARGET})
  add_subdirectory(${CEF_LIBCEF_DLL_WRAPPER_PATH} libcef_dll_wrapper)
  target_link_libraries(${COGNISTREAM_TARGET} libcef_dll_wrapper ${CEF_STANDARD_LIBS})
  set_target_properties(${COGNISTREAM_TARGET} PROPERTIES
    MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_SOURCE_DIR}/mac/Info.plist.in
  )

  # CEF í”„ë ˆì„ì›Œí¬ë¥¼ Frameworks ë””ë ‰í† ë¦¬ì— ë³µì‚¬
  add_custom_command(
    TARGET ${COGNISTREAM_TARGET}
    POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory
    "${CEF_BINARY_DIR}/Chromium Embedded Framework.framework"
    "${CEF_APP}/Contents/Frameworks/Chromium Embedded Framework.framework"
    VERBATIM
  )

  # ì—¬ëŸ¬ Helper ì•± ë²ˆë“¤ íƒ€ê²Ÿ ìƒì„±
  foreach(_suffix_list ${CEF_HELPER_APP_SUFFIXES})
    # ì ‘ë¯¸ì‚¬ ê°’ì„ ì¶”ì¶œ
    string(REPLACE ":" ";" _suffix_list ${_suffix_list})
    list(GET _suffix_list 0 _name_suffix)
    list(GET _suffix_list 1 _target_suffix)
    list(GET _suffix_list 2 _plist_suffix)

    # Helper íƒ€ê²Ÿ ë° ì¶œë ¥ ì´ë¦„ ì„¤ì •
    set(_helper_target "${CEF_HELPER_TARGET}${_target_suffix}")
    set(_helper_output_name "${CEF_HELPER_OUTPUT_NAME}${_name_suffix}")

    # Helper-specific Info.plist íŒŒì¼ ìƒì„±
    set(_helper_info_plist "${CMAKE_CURRENT_BINARY_DIR}/helper-Info${_target_suffix}.plist")
    file(READ "${CMAKE_CURRENT_SOURCE_DIR}/mac/helper-Info.plist.in" _plist_contents)
    string(REPLACE "\${EXECUTABLE_NAME}" "${_helper_output_name}" _plist_contents ${_plist_contents})
    string(REPLACE "\${PRODUCT_NAME}" "${_helper_output_name}" _plist_contents ${_plist_contents})
    string(REPLACE "\${BUNDLE_ID_SUFFIX}" "${_plist_suffix}" _plist_contents ${_plist_contents})
    file(WRITE ${_helper_info_plist} ${_plist_contents})

    # Helper ì‹¤í–‰ íŒŒì¼ íƒ€ê²Ÿ ìƒì„±
    add_executable(${_helper_target} MACOSX_BUNDLE ${COGNISTREAM_HELPER_SRCS})
    SET_EXECUTABLE_TARGET_PROPERTIES(${_helper_target})
    add_dependencies(${_helper_target} libcef_dll_wrapper)
    target_link_libraries(${_helper_target} libcef_dll_wrapper ${CEF_STANDARD_LIBS})
    set_target_properties(${_helper_target} PROPERTIES
      MACOSX_BUNDLE_INFO_PLIST ${_helper_info_plist}
      OUTPUT_NAME ${_helper_output_name}
    )

    if(USE_SANDBOX)
      target_link_libraries(${_helper_target} cef_sandbox_lib)
    endif()

    # Helperë¥¼ ë©”ì¸ íƒ€ê²Ÿì˜ ì¢…ì†ì„±ìœ¼ë¡œ ì¶”ê°€
    add_dependencies(${COGNISTREAM_TARGET} "${_helper_target}")

    # Helper ì•± ë²ˆë“¤ì„ Frameworks ë””ë ‰í† ë¦¬ì— ë³µì‚¬
    add_custom_command(
      TARGET ${COGNISTREAM_TARGET}
      POST_BUILD
      COMMAND ${CMAKE_COMMAND} -E copy_directory
      "${CEF_TARGET_OUT_DIR}/${_helper_output_name}.app"
      "${CEF_APP}/Contents/Frameworks/${_helper_output_name}.app"
      VERBATIM
    )
  endforeach()

  # ë¦¬ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ë™ ì²˜ë¦¬ ë° ë³µì‚¬
  set(PREFIXES "mac/")
  COPY_MAC_RESOURCES("${COGNISTREAM_RESOURCES_SRCS}" "${PREFIXES}" "${COGNISTREAM_TARGET}" "${CMAKE_CURRENT_SOURCE_DIR}" "${CEF_APP}")
endif()


#
# Windows êµ¬ì„±
#

if(OS_WINDOWS)
  # ì‹¤í–‰ íŒŒì¼ íƒ€ê²Ÿ ìƒì„±
  add_executable(${COGNISTREAM_TARGET} WIN32 ${COGNISTREAM_SRCS})
  add_subdirectory(${CEF_LIBCEF_DLL_WRAPPER_PATH} libcef_dll_wrapper)
  SET_EXECUTABLE_TARGET_PROPERTIES(${COGNISTREAM_TARGET})
  target_link_libraries(${COGNISTREAM_TARGET} libcef_lib libcef_dll_wrapper ${CEF_STANDARD_LIBS})

  if(USE_SANDBOX)
    # cef_sandbox ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§í¬í•˜ê¸° ìœ„í•œ ë…¼ë¦¬ íƒ€ê²Ÿ
    ADD_LOGICAL_TARGET("cef_sandbox_lib" "${CEF_SANDBOX_LIB_DEBUG}" "${CEF_SANDBOX_LIB_RELEASE}")
    target_link_libraries(${COGNISTREAM_TARGET} cef_sandbox_lib ${CEF_SANDBOX_STANDARD_LIBS})
  endif()

  # ì‹¤í–‰ íŒŒì¼ì— ì»¤ìŠ¤í…€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì¶”ê°€
  ADD_WINDOWS_MANIFEST("${CMAKE_CURRENT_SOURCE_DIR}/win" "${COGNISTREAM_TARGET}" "exe")
  ADD_WINDOWS_TORCH_DLLS(${COGNISTREAM_TARGET} ${TORCH_INSTALL_PREFIX})

  # ë°”ì´ë„ˆë¦¬ ë° ë¦¬ì†ŒìŠ¤ íŒŒì¼ì„ íƒ€ê²Ÿ ì¶œë ¥ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
  COPY_FILES("${COGNISTREAM_TARGET}" "${CEF_BINARY_FILES}" "${CEF_BINARY_DIR}" "${CEF_TARGET_OUT_DIR}")
  COPY_FILES("${COGNISTREAM_TARGET}" "${CEF_RESOURCE_FILES}" "${CEF_RESOURCE_DIR}" "${CEF_TARGET_OUT_DIR}")


endif()


#
# CEF ì„¤ì • ì¶œë ¥
#
PRINT_CEF_CONFIG()


#
# íŒ¨í‚¤ì§€ ìƒì„± ì„¤ì •
#

# if(OS_WINDOWS)
#   set(CPACK_GENERATOR "NSIS")
# elseif(OS_MAC)
#   set(CPACK_GENERATOR "DragNDrop")
# elseif(OS_LINUX)
#   set(CPACK_GENERATOR "TGZ")
# endif()

# set(CPACK_PACKAGE_NAME "cognistream")
# set(CPACK_PACKAGE_VENDOR "jeongro.net")
# set(CPACK_PACKAGE_VERSION "0.0.1")
# set(CPACK_PACKAGE_FILE_NAME "${CPACK_PACKAGE_NAME}-${CPACK_PACKAGE_VERSION}")

# install(TARGETS ${COGNISTREAM_TARGET} DESTINATION .)

# include(CPack)